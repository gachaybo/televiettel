var api={listCourse:'/learning',getCourse:'CodeCamp/Course/GetCourse/'+courseId,registerCourse:'CodeCamp/Course/RegisterCourse',detail:'/learning/',noImg:resourcePath+'/Images/no-image.png',courseActive:resourcePath+'/Images/code-learn/bg-Lesson.png',courseNotActive:resourcePath+'/Images/code-learn/bn-2.png',listUser:'/learning/listUser/'+courseId,checkUserProfileStatusUri:'',getCertificationUser:'/CodeCamp/Course/GetCertification/'+courseId,editCourse:'/learning/edit/'+courseId,}
var fixSubtring=240;var numberComplete=0;var subCourseName=45;var subOwnerName=10;var isLock=false;var isShowLesson=false;var isShowPractice=false;function register(){$('#course-register').click(function(){var referRegister=getReferRegister();var activeCode='';if(isRequiredCode){activeCode=prompt(translate.instant('SERVER_MSG_11011'),'');if(activeCode==''){alert(translate.instant('SERVER_MSG_11012'));return false;}}
if((activeCode==null||activeCode=='')&&isRequiredCode){return false;}
var requestParam={'eventKey':referRegister.EventKey,'refer':referRegister.Refer,'courseId':courseId,'activeCode':activeCode};if(!isLock){isLock=true;PKLService.post({url:api.registerCourse,data:JSON.stringify(requestParam),contentType:"application/json; charset=utf-8",OnSuccess:function(response){fbq('track','FinishRegistration',{});isLock=false;location.reload();},OnError:function(){isLock=false;}});}});}
function displayCourses(elm,type,listTask,tasksComplete,tasksFail,isAdmin,isResisted,taskDependencies,isTimeComplete){taskDependencies=false;var cnt=1;var nextTask=0;var cntSection=0;var indexMaxTaskComplete=-1;var lenTaskComplete=tasksComplete.length;if(tasksComplete.length>0){indexMaxTaskComplete=listTask.map(function(e){return e.TaskId;}).indexOf(tasksComplete[lenTaskComplete-1]);}
var lock=true;for(var i=0;i<listTask.length;i++){var item=listTask[i];var content='';if(item.Type==type){if(item.TaskId==0){content+='<div class="group-detail-course-item col-md-6">';content+=' <div class="course-name">';content+='  <div class="lession"><img src="'+api.courseActive+'" />';content+='  <div class="title"><h3 class="not-Active active" title="'+item.SectionName+'">'+item.SectionName.substring(0,subCourseName)+(item.SectionName.length>subCourseName?'...':'')+'</h3></div></div>';content+=' <div class="contain-task">';content+=' </div>';content+=' </div>';content+='</div>';lock=true;$('#'+elm+'.list-task').append(content);if(type==1){isShowLesson=true;}
if(type==2){isShowPractice=true;}}else{var isComplete=tasksComplete.indexOf(item.TaskId)>-1;if(isComplete){var resolve='resolve';if(tasksFail!=null&&tasksFail.length>0){if(tasksFail.indexOf(item.TaskId)>-1){resolve='not-pass';}}
numberComplete++;nextTask=cnt+1;content+='<a href="'+api.detail+permalink+'/'+item.TaskId+'" class="circle '+resolve+'">'+cnt+'</a>';$('div.course-name h3:last').removeClass("notActive").attr('class',"active");lock=false;}else{content+='<a href="'+api.detail+permalink+'/'+item.TaskId+'" class="circle allow-active">'+cnt+'</a>';}
if(i<listTask.length-2){if((listTask[i+1].TaskId==0||i==listTask.length)&&lock==true){}}
else if(i==listTask.length-1&&lock==true){}
$('#'+elm+'.list-task .group-detail-course-item:last div.contain-task').append(content);cnt++;}}}}
function time_convert(num){var hours=Math.floor(num/60);var minutes=num%60;return(hours>9?hours:'0'+hours)+":"+(minutes>9?minutes:'0'+minutes);}
function displayCourseDetail(data){var color='#DBDBDB';if(data){$('#total-rating').text("("+data.TotalRating+' '+translate.instant("COURSE_LABEL_RATING")+")");var avar=resourcePath+"/Images/code-learn/user-default.svg";if(data.AvatarUser){avar=s3Storage+data.AvatarUser;}
var LevelCss=data.UserLevel.IsAdmin?"admin":data.UserLevel.IsContributor?"contributor":"";var levelAvatar=s3Storage+data.UserExpLevel.IconUrl;$('#owner').addClass(LevelCss);$('#owner').html("<div class='avatars'><img class='level-avatar' src='"+levelAvatar+"'/><img class='user-avatars' src='"+avar+"'></div><a class='owner' title='"+data.Ower+"' href='"+cvUrl+data.OwnerId+"'>"+data.Ower+"</a>");$('#total-task').append(data.TotalTask+" "+translate.instant('COURSE_LABEL_LESSONS'));$('#time-es').append((data.EstimateTimeComplete*3600).toString().toHHMMSS());$('#category').append("<a href='"+api.listCourse+"'>"+data.CourseTypeName+"</a>");if(data.IsAdmin){var link='<a href="'+api.listUser+'"target="_blank">'+data.TotalEnroll+' '+translate.instant('COURSE_LABEL_STUDENTS')+'</a>';$('#total-enrolled').append(link);}else{$('#total-enrolled').text(data.TotalEnroll+' '+translate.instant('COURSE_LABEL_STUDENTS'));}
if(data.AllowEdit){$('#action-edit').attr('href',api.editCourse).removeClass('hide');}
if(data.UserReisted){userReisted=data.UserReisted;$('#button-register').removeClass('col-sm-2 register');$('#course-register').removeClass('course-register hidden');$('#course-register').removeClass('user-register');$('#course-register').removeClass('btn btn-primary');}else{if(!isAuthen){$('#not-auth').removeClass('hide');}else{$('#course-register').removeClass('course-registered').removeClass('hidden').addClass('course-register');$('#course-register').text(translate.instant("PAGES_HOME_ACTION_REGISTERED_NOW"));register();}
$('#course-progress').addClass('hide');}
if(!data.IsTimeRegister&&!data.UserReisted){$('#course-register').remove();$('#course-notice').removeClass('hidden').html("<strong>"+translate.instant("COURSE_PENDING_MESSAGE")+" "+data.StartTime.getLocalDate()+"</strong>");}
displayRate(Math.floor(data.AverageRate),data.TotalRating,data.AverageRate);if(data.ListTask&&data.ListTask.length>0){displayCourses('1a',0,data.ListTask,data.TasksCompelete,data.ListTaskFail,data.IsAdmin,data.UserReisted,data.TaskDependencies,data.IsTimeComplete);displayCourses('course-lesson',1,data.ListTask,data.TasksCompelete,data.ListTaskFail,data.IsAdmin,data.UserReisted,data.TaskDependencies,data.IsTimeComplete);displayCourses('course-practice',2,data.ListTask,data.TasksCompelete,data.ListTaskFail,data.IsAdmin,data.UserReisted,data.TaskDependencies,data.IsTimeComplete);if(isShowLesson){$('#course-lesson').removeClass('hide');$('li.course-lesson').removeClass('hide');}
if(isShowPractice){$('#course-practice').removeClass('hide');$('li.course-practice').removeClass('hide');}}
if(data.TasksCompelete&&data.TasksCompelete.length>0){var percent=data.CompletedPercent<0?(data.TasksCompelete.length/data.TotalTask)*100:data.CompletedPercent;var color='#DBDBDB';var activeBorder='background-color: #DBDBDB;';if(percent==100){color='#7BC043';activeBorder='background-color: #7BC043;';}else{color='#DBDBDB';activeBorder='background-color: #F69046;';}
coursePercent=Math.floor(percent);$('#circle span').text(coursePercent+'%');percent=percent*3.6;if(percent<180){$('div #activeBorder').attr('style','background-image: linear-gradient('+(percent+90)+'deg, transparent 50%, '+color+' 50%),linear-gradient(90deg, #DBDBDB 50%, transparent 50%);'+activeBorder);}
else if(percent>=180&&percent<360){color='#F69046';$('div #activeBorder').attr('style','background-image: linear-gradient('+(percent-90)+'deg, transparent 50%, '+color+' 50%),linear-gradient(90deg, #DBDBDB 50%, transparent 50%);'+activeBorder);}
else{$('div #activeBorder').attr('style','background-image: linear-gradient('+(percent-90)+'deg, transparent 50%, '+color+' 50%),linear-gradient(90deg, #DBDBDB 50%, transparent 50%);'+activeBorder);}}else{$('#circle span').text('0%');$('div #activeBorder').attr('style','background-image: linear-gradient(90deg, transparent 50%, #DBDBDB 50%),linear-gradient(90deg, #DBDBDB 50%, transparent 50%);');}
$('#activeBorder').removeClass('hide');}}
function displayRate(number,totalRating,avgRate){let avg_rating=100;avg_rating=(parseFloat(avgRate)*100/5);var txt='';txt+='<span class="star-rating">';txt+='<span style="width:'+avg_rating+'%"></span>';txt+='<span class="vote-rate">';for(var i=1;i<5+1;i++){txt+='<span value="'+i+'" class="star"><i id="img-owner" class="icon ion-ios-star star"></i></span>';}
txt+='</span></span>';txt+='<span class="text-rate">'+avgRate+' ('+totalRating+' '+translate.instant('COURSE_LABEL_RATING')+')</span>';$('#container-rate').append(txt);rateClick();}
function getCertification(){$.get(api.getCertificationUser,function(data){$(".certification").append(data);$(".certification").find('.progress .current-progress').css("width",coursePercent+'%');$(".certification").find('.progress .current-progress-value').text(coursePercent);checkVerScrollBarDisplay();});}
function rateClick(){$('span.star').click(function(){if(api.checkUserProfileStatusUri){PKLService.get({url:api.checkUserProfileStatusUri,OnSuccess:function(data){if(data.Data.NotOK){location.assign(data.Data.RequireProfileUpdateUrl);}else{rate(courseId,$(this).attr('value'));}}});}else{rate(courseId,$(this).attr('value'));}});}
$(function(){translate.onLoad(function(){var $start_tour_template='<div class="wrap-start-tour-block"><div class="start-tour-content">\
        <h3 class="tour-heading">'+translate.instant('COURSE_TOURE_1')+'</h3>\
        <h4 class="tour-des">'+translate.instant('COURSE_TOURE_2')+'</h4>\
        <div class="tour-buttons"><a href="#" class="tour-btn continue-tour-btn" title="'+translate.instant('COURSE_TOURE_CONTINURE')+'">'+translate.instant('COURSE_TOURE_CONTINURE')+'</a><a href="#" class="tour-btn cancel-tour-btn" title="'+translate.instant('COURSE_TOURE_SKIP')+'">'+translate.instant('COURSE_TOURE_SKIP')+'</a></div>\
        </div></div>';function cl_courseTour(){$('body').append($start_tour_template);}
var tour;$(document).on('click','.start-tour-content .tour-btn',function(e){e.preventDefault();if($(this).hasClass('continue-tour-btn')){if($('#exTab1 .extab a[href="#course-lesson"]:visible')[0]){$('#exTab1 .extab a[href="#course-lesson"]:visible').trigger('click');}else{$('#exTab1 .extab a[href="#1a"]:visible').trigger('click');}
if(!tour){tour=new Tour({debug:true,backdrop:true,backdropPadding:10,smartPlacement:false,storage:false,placement:'bottom',template:"<div class='popover tour cl-tour'>\
                    <h3 class='popover-title'></h3>\
                    <div class='popover-content'></div>\
                    <div class='popover-navigation'>\
                        <button class='tour-btn sec-tour-btn' data-role='prev'>"+translate.instant('COURSE_TOURE_BACK')+"</button>\
                        <button class='tour-btn' data-role='next'>"+translate.instant('COURSE_TOURE_CONTINURE')+"</button>\
                        <button class='tour-btn finish-tour disabled' data-role='end'>"+translate.instant('COURSE_TOURE_COMPLETE')+"</button>\
                        <button class='tour-btn cancel-tour-btn' data-role='end'>"+translate.instant('COURSE_TOURE_SKIP')+"</button>\
                    </div>\
                    </div> ",onEnd:function(tour){$('body').removeClass('on-tour');if(!getCookie('cl_course_tour')){setCookie('cl_course_tour',1,30);}},});if($('#not-auth')[0]){tour.addStep({element:"#not-auth",title:translate.instant('COURSE_TOURE_3'),placement:$(window).width()>992?"left":"bottom",});}
if($('#course-register.course-register')[0]){tour.addStep({element:"#course-register.course-register",title:translate.instant('COURSE_TOURE_5'),placement:$(window).width()>992?"left":"bottom",});}
if($('#course-register.buy-now.btn-enter-code')[0]){tour.addStep({element:"#course-register.buy-now.btn-enter-code",title:translate.instant('COURSE_TOURE_6'),placement:$(window).width()>992?"left":"bottom",});}
if($('#course-lesson .group-detail-course-item .contain-task>a')[0]){tour.addStep({element:"#course-lesson .group-detail-course-item:first-child .contain-task>a:first-child",title:translate.instant('COURSE_TOURE_4'),placement:$(window).width()>992?"right":"bottom",});}else{tour.addStep({element:"#1a .group-detail-course-item:first-child .contain-task>a:first-child",title:translate.instant('COURSE_TOURE_4'),placement:$(window).width()>992?"right":"bottom",});}}
if(tour.ended()){tour.init();}
setTimeout(function(){if(tour.ended()){tour.restart();}else{tour.start();}},300);$('body').addClass('on-tour');}else{setCookie('cl_course_tour',1,30);}
$('.wrap-start-tour-block').fadeOut();});$(document).on('click','.open-tour',function(e){e.preventDefault();if($('.wrap-start-tour-block')[0]){$('.wrap-start-tour-block').fadeIn();}else{cl_courseTour();}});getCertification();if(!userReisted&&!getCookie('cl_course_tour')&&(typeof Tour!="undefined")){cl_courseTour();}
rateClick();if(!userReisted){register();}
var courseNotice=$('#course-notice strong');if(courseNotice.length>0){var time=courseNotice.attr('time');$('#course-notice span').text(time.getLocalDate());}
$(document).on('click','.section-item__overview',function(e){e.preventDefault();$(this).siblings('.section-item__content').slideToggle(200);$(this).toggleClass('active');});$('.section-item .section-item__content').slideDown();$('.section-item .section-item__overview').addClass('active');});});